# 智能路由功能使用指南

本系统实现了基于IP地址的智能路由功能，可以根据访问源自动决定显示管理界面还是用户界面。

## 工作原理

系统会自动检测访问者的IP地址，并根据以下规则决定显示的界面：

1. 如果访问来自服务器本机IP（包括localhost, 127.0.0.1）或配置的服务器IP地址，则自动重定向到管理员登录界面
2. 如果访问来自其他设备（如树莓派），则显示标准用户界面

这种机制确保了：
- 管理员（通常在服务器或主机上工作）可以直接进入管理界面
- 树莓派设备默认显示用户操作界面，适合安装在门禁、设备控制面板等位置

## 配置方法

### 基本配置

无需特殊配置，系统会自动检测本机IP地址，并将这些地址视为"管理员访问"。

### 自定义服务器IP

如果需要指定特定的服务器IP地址（例如在多网卡环境或代理服务器背后），可以通过环境变量配置：

```bash
# Linux/macOS
export SERVER_IP=192.168.5.201
node server.js

# Windows
set SERVER_IP=192.168.5.201
node server.js
```

也可以在启动命令中直接指定：

```bash
SERVER_IP=192.168.5.201 npm start
```

### 在Docker中配置

如果使用Docker部署，可以在docker-compose.yml文件中设置环境变量：

```yaml
services:
  web:
    image: rpi-panel
    ports:
      - "4000:4000"
    environment:
      - SERVER_IP=192.168.5.201
```

## 故障排查

系统提供了一个专用的调试端点，用于检查IP检测机制是否正常工作：

1. 访问 `http://服务器IP:4000/debug-ip`
2. 页面将显示以下信息：
   - 检测到的客户端IP地址
   - 是否被识别为本地/服务器访问
   - 服务器识别的IP地址列表
   - 当前配置的服务器IP
   - 浏览器的引用来源和用户代理

如果IP检测结果不符合预期，可能的原因包括：
- 使用了代理服务器或VPN
- 防火墙或网络配置阻止了某些头信息
- 服务器运行在容器或虚拟环境中，导致网络接口识别不准确

## 手动访问特定界面

无论IP检测结果如何，您始终可以通过直接访问特定URL进入所需界面：

- 管理员界面: `http://服务器IP:4000/admin-login`
- 用户界面: `http://服务器IP:4000/user`

## 禁用智能路由

如果需要暂时禁用智能路由功能，可以设置环境变量`DISABLE_SMART_ROUTING=true`：

```bash
DISABLE_SMART_ROUTING=true npm start
```

这将使所有访问默认显示用户界面，无论IP地址如何。 